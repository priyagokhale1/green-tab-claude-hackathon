# Weekly Email "GreenTab Wrapped" Setup Guide

## Overview

This feature allows users to opt into receiving weekly email recaps with personalized insights about their energy, water, and COâ‚‚ consumption, generated by Claude AI - like a "GreenTab Wrapped"!

## Architecture

1. **Database**: Store opt-in status and email addresses in Supabase
2. **Email Service**: Resend (modern, developer-friendly, good free tier)
3. **Scheduling**: Manual testing via dashboard button or API call (for local development)
4. **AI Generation**: Claude API for personalized email content

## Step 1: Set Up Resend

1. **Create Resend Account**:
   - Go to https://resend.com
   - Sign up for a free account (includes 3,000 emails/month)
   - Verify your email address

2. **Get Your API Key**:
   - Go to API Keys in Resend dashboard
   - Create a new API key
   - Copy the key (starts with `re_`)

3. **Add Domain (Optional for Production)**:
   - For production, add and verify your domain
   - For testing, you can use the default `onboarding@resend.dev` sender
   - Or use a custom "from" email like `GreenTab <noreply@greentab.app>`

4. **Add to Environment Variables**:
   Add to `dashboard/.env.local`:
   ```env
   RESEND_API_KEY=re_your_api_key_here
   RESEND_FROM_EMAIL=GreenTab <noreply@greentab.app>
   ```

## Step 2: Set Up Database Schema

Run this SQL in Supabase SQL Editor:

```sql
-- Create email_subscriptions table
CREATE TABLE IF NOT EXISTS email_subscriptions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL UNIQUE REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT NOT NULL,
  opted_in BOOLEAN DEFAULT true,
  last_sent_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create index for faster queries
CREATE INDEX IF NOT EXISTS idx_email_subscriptions_user_id 
  ON email_subscriptions(user_id);

-- Enable Row Level Security
ALTER TABLE email_subscriptions ENABLE ROW LEVEL SECURITY;

-- Create policy: users can only see/edit their own subscription
CREATE POLICY "Users can view own email subscription"
  ON email_subscriptions FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own email subscription"
  ON email_subscriptions FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own email subscription"
  ON email_subscriptions FOR UPDATE
  USING (auth.uid() = user_id);
```

## Step 3: Test Locally

1. **Start the dashboard**: 
   ```bash
   cd dashboard
   npm run dev
   ```

2. **Test opt-in**: 
   - Go to `http://localhost:3000/dashboard`
   - Scroll to the bottom to the "Weekly Email Recap" section
   - Click "Opt In to Weekly Emails"
   - Enter your email address
   - Click "Subscribe"

3. **Test email immediately**: 
   - After subscribing, click the "ðŸ“§ Send Test Email" button
   - Check your inbox for the test email

## Sending Weekly Emails Locally

Since you're running locally, automated weekly emails won't run automatically. You have a few options:

### Option 1: Manual Testing (Recommended for Development)
- Use the "Send Test Email" button in the dashboard whenever you want to test
- This sends the weekly recap to your subscribed email immediately

### Option 2: Manual API Call
You can manually trigger the weekly email endpoint:
```bash
# In your browser or using curl:
curl -X GET http://localhost:3000/api/email/send-weekly
```

### Option 3: Local Cron (Optional)
If you want automated weekly emails on your local machine, you can set up a local cron job:
```bash
# Edit your crontab
crontab -e

# Add this line to run every Monday at 9 AM:
0 9 * * 1 curl -X GET http://localhost:3000/api/email/send-weekly
```

**Note:** This requires your local server to be running 24/7, which is usually not practical for development.

## Cost Estimates (Local Development)

- **Resend**: Free tier includes 3,000 emails/month (plenty for testing)
- **Claude API**: ~$0.25 per 1M tokens (very cheap for email summaries)
- **Total per test email**: ~$0.001 (essentially free for development)

Since you're running locally, you'll only send emails when you manually trigger them, so costs are minimal.

## Privacy & Compliance

- Users explicitly opt-in
- Email addresses are stored securely in Supabase
- Users can opt-out anytime
- Consider adding terms of service checkbox

## Email Content

The weekly email includes:
- Personalized greeting with user's name
- Key stats (energy, water, COâ‚‚)
- Top sites visited
- Fun comparisons and insights
- Generated by Claude AI for a personalized "wrapped" experience

