# Authentication Setup Guide

This guide explains how to set up optional Google sign-in for GreenTab.

> **ðŸ“– For a detailed step-by-step walkthrough with exact clicks and screenshots descriptions, see [STEP_BY_STEP_SETUP.md](./STEP_BY_STEP_SETUP.md)**

## Overview

The extension now supports **optional** Google authentication:
- **Without signing in**: The extension works exactly as before - all data is stored locally and shown in real-time in the popup
- **With signing in**: Data is synced to your backend database for viewing analytics on the dashboard website

## How It Works

1. Users can use the extension without any account (default behavior)
2. A "Sign in with Google" button appears at the bottom of the popup
3. When signed in, data automatically syncs to the backend every 5 minutes
4. Users can view detailed analytics on the dashboard website

## Setup Instructions

### Step 1: Set Up Supabase (or your backend)

1. Create a Supabase project at https://supabase.com
2. Note your project URL and anon key from Settings â†’ API

### Step 2: Enable Google OAuth in Supabase

1. Go to Authentication â†’ Providers in your Supabase dashboard
2. Enable Google provider
3. Add your OAuth credentials:
   - Get Client ID and Client Secret from [Google Cloud Console](https://console.cloud.google.com)
   - Add redirect URL: `https://your-project.supabase.co/auth/v1/callback`

### Step 3: Configure Chrome Extension

Update the following in `popup.js` (lines 18-19) and `background.js` (lines 16-17):

```javascript
const SUPABASE_URL = 'https://your-project.supabase.co';
const SUPABASE_ANON_KEY = 'your-anon-key-here';
```

### Step 4: Set Up Database Schema

Run this SQL in your Supabase SQL editor:

```sql
-- Create tracking_data table
CREATE TABLE IF NOT EXISTS tracking_data (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  domain TEXT NOT NULL,
  total_seconds INTEGER NOT NULL DEFAULT 0,
  energy_wh FLOAT,
  water_liters FLOAT,
  co2_grams FLOAT,
  synced_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(user_id, date, domain)
);

-- Create index for faster queries
CREATE INDEX IF NOT EXISTS idx_tracking_data_user_date 
  ON tracking_data(user_id, date DESC);

CREATE INDEX IF NOT EXISTS idx_tracking_data_user_domain 
  ON tracking_data(user_id, domain);

-- Enable Row Level Security
ALTER TABLE tracking_data ENABLE ROW LEVEL SECURITY;

-- Create policy: users can only see/edit their own data
CREATE POLICY "Users can view own tracking data"
  ON tracking_data FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own tracking data"
  ON tracking_data FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own tracking data"
  ON tracking_data FOR UPDATE
  USING (auth.uid() = user_id);
```

### Step 5: Update Chrome Extension Manifest

The manifest.json already includes the `identity` permission needed for OAuth. If you haven't updated it, add:

```json
"permissions": [
  "tabs",
  "activeTab",
  "storage",
  "identity"
]
```

### Step 6: Configure OAuth Redirect URL

In your Supabase dashboard:
1. Go to Authentication â†’ URL Configuration
2. Add your Chrome extension redirect URL:
   - The redirect URL is automatically generated by Chrome: `https://[extension-id].chromiumapp.org/`
   - You can get your extension ID from `chrome://extensions` after loading the extension
   - Or use: `chrome-extension://[extension-id]/` format

Alternatively, for development, you can:
1. Load the extension unpacked
2. Check the extension ID in `chrome://extensions`
3. Add `https://[extension-id].chromiumapp.org/` to Supabase redirect URLs

## How It Works for Users

### Without Sign-In (Default)
- Extension works normally
- All data stored locally in Chrome storage
- Real-time usage shown in popup
- No backend connection needed

### With Sign-In
1. User clicks "Sign in with Google" at bottom of popup
2. OAuth flow opens in new window
3. After successful auth, user info appears in popup
4. Background script starts syncing data every 5 minutes
5. User can visit dashboard website to view analytics

### Sign Out
- User clicks "Sign out" button
- Auth data is cleared
- Sync stops
- Extension continues working locally

## Testing

1. Load the extension unpacked in Chrome
2. Without sign-in: Verify extension works normally
3. With sign-in: 
   - Click "Sign in with Google"
   - Complete OAuth flow
   - Verify user info appears
   - Check browser console for sync logs
   - Verify data appears in Supabase database

## Troubleshooting

### "Authentication is not configured" error
- Make sure `SUPABASE_URL` and `SUPABASE_ANON_KEY` are set in both `popup.js` and `background.js`

### OAuth flow fails
- Verify redirect URLs are configured in Supabase
- Check Google OAuth credentials are correct
- Ensure `identity` permission is in manifest.json

### Data not syncing
- Check browser console for errors
- Verify authentication is working (check chrome.storage.sync)
- Ensure database schema and RLS policies are set up correctly

## Next Steps

After authentication is set up:
1. Create the dashboard website
2. Use the same Supabase project for the dashboard
3. Fetch and display user data from the `tracking_data` table
4. Create visualizations (charts, graphs, etc.)

